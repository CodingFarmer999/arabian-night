<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>天方夜譚 - 查詢事件</title>
    <!-- 引入 HTMX WebJar -->
    <script th:src="@{/webjars/htmx.org/2.0.2/dist/htmx.min.js}"></script>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body>
    <div class="container">
        <h1>直接查詢事件 (Event Lookup)</h1>

        <div style="margin-bottom: 2rem;">
            <a href="/">&larr; 回首頁 (Back to Home)</a>
        </div>

        <form hx-post="/event-lookup" hx-target="#direct-result" hx-swap="innerHTML">
            <div style="margin-bottom: 1rem;">
                <label for="lookupEventId">事件編號 (Event ID):</label>
                <input type="number" id="lookupEventId" name="eventId" required
                    style="padding: 0.5rem; width: 100%; box-sizing: border-box;">
            </div>
            <button type="submit" style="background: #6c757d;">查詢事件 (Search Event)</button>
        </form>

        <div id="direct-result" style="margin-top: 1rem;"></div>

        <!-- Hidden Fragment Definition for Story Display (Used by Controller) -->
        <div style="display: none;">
            <div id="story-display" th:fragment="story-display"
                style="margin-top: 1rem; padding-top: 1rem; border-top: 2px dashed #ccc;">
                <div th:if="${event != null}">
                    <h3 th:text="${event.title}">Story Title</h3>
                    <div th:utext="${event.description}"
                        style="background: #fdf6e3; padding: 1rem; border-radius: 4px; line-height: 1.6; margin-bottom: 1rem;">
                        Story description goes here...
                    </div>

                    <h4>可能的結果 (請根據您的狀態/技能選擇):</h4>
                    <div th:if="${event.outcomes != null}" style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <!-- Root level outcomes -->
                        <th:block th:each="outItem : ${event.outcomes}">
                            <div th:replace="~{:: outcomeFragment(outcome=${outItem})}"></div>
                        </th:block>
                    </div>
                    <p th:if="${event.outcomes == null || event.outcomes.empty}">沒有列出特定結果。</p>
                </div>
            </div>

            <!-- Recursive Fragment for Outcomes -->
            <div th:fragment="outcomeFragment(outcome)"
                style="border: 1px solid #eee; border-radius: 4px; overflow: hidden; margin-bottom: 0.5rem;">
                <details style="background: #fff;" th:if="${outcome != null}">
                    <summary style="padding: 0.5rem; cursor: pointer; background: #e9ecef; font-weight: bold;">
                        <span th:text="${outcome.conditionParam}">Skill Check</span>
                    </summary>
                    <div style="padding: 1rem; border-top: 1px solid #eee;">
                        <!-- If there are children, render them recursively -->
                        <div th:if="${not #lists.isEmpty(outcome.children)}"
                            style="padding-left: 1rem; border-left: 2px solid #ccc;">
                            <th:block th:each="childItem : ${outcome.children}">
                                <div th:replace="~{:: outcomeFragment(outcome=${childItem})}"></div>
                            </th:block>
                        </div>

                        <!-- If text OR reward is present -->
                        <div
                            th:if="${(outcome.outcomeText != null && outcome.outcomeText != '') || (outcome.rewardStr != null && outcome.rewardStr != '')}">
                            <p th:if="${outcome.outcomeText != null && outcome.outcomeText != ''}"
                                style="margin-top: 0;">
                                <strong>結果：</strong> <span th:text="${outcome.outcomeText}">You win!</span>
                            </p>
                            <p th:if="${outcome.rewardStr != null && outcome.rewardStr != ''}"
                                style="margin-bottom: 0; color: #d9534f;">
                                <strong>獎勵：</strong> <span th:text="${outcome.rewardStr}">+1 Destiny</span>
                            </p>
                        </div>
                    </div>
                </details>
            </div>
        </div>

    </div>
</body>

</html>